version: '3.7'

services:
  mockserver:
    image: node:14
    working_dir: /app
    command: node mockserver.js
    environment:
      NODE_ENV: production
      PORT: 3500
      WEBHOOK_HOST: benchmark
      WEBHOOK_PORT: 4000
      BLACKHOLE_WEBHOOK: yep
    networks:
      - http
    volumes:
      - .:/app
    deploy:
      replicas: 3
      endpoint_mode: dnsrr

  controller:
    image: node:14
    working_dir: /app
    command: node controller.js
    ports:
      - 6550:8080
    environment:
      NODE_ENV: production
      TARGET_HOST: mockserver
      TARGET_PORT: 3500
      WEBHOOK_PORT: 4000
      DATA_DIR: /data
      BATCH_SIZE: 300
      BATCH_WINDOW: 500
    networks:
      - http
    volumes:
      - .:/app

  worker:
    image: node:14
    working_dir: /app
    command: node worker.js
    depends_on:
      - mockserver
      - controller
    environment:
      NODE_ENV: production
      WEBHOOK_PORT: 4000
    networks:
      - http
    volumes:
      - .:/app
    deploy:
      replicas: 3

networks:
  http:
